const bodyParser = require('body-parser');
const cookieParser = require('cookie-parser')
const fs = require('fs');
const jwt = require('jsonwebtoken');


// function parseCookies (request) {
//     var list = {},
//         rc = request.headers.cookie;

//     rc && rc.split(';').forEach(function( cookie ) {
//         var parts = cookie.split('=');
//         list[parts.shift().trim()] = decodeURI(parts.join('='));
//     });

//     return list;
// }

module.exports = function (gatewayExpressApp) {
  gatewayExpressApp.use(bodyParser.json());

  
    gatewayExpressApp.get('/test',(req,res)=>{
        res.send('Done.')
    })
  // gatewayExpressApp.use('/*',(req,res,next)=>{
  //   if(req.headers['host'] == 'localhost:8080'){
  //     console.log('http');
  //     if(req.originalUrl == '/api/url1'){
  //       console.log("here we go.");
  //       console.log(req.headers.cookie);
  //     }
  //     const reqUrl =  `http://localhost:8081/auth?issuerHost=http://localhost:8081&client_id=foobar&redirect_uri=https://example.com&scope=openid&response_type=id_token+token&nonce=1122`
  //     res.redirect(reqUrl);
  //   }
  //   else if(req.headers['host'] == 'localhost:9443'){
  //     console.log('https')
  //     next();
  //   }
  //   });

  // gatewayExpressApp.get('/api/this',(req,res)=>{
  //   console.log("This is cookie");
  //   console.log(res);
  //   res.send("cookieParser")
  // })

  // gatewayExpressApp.get('api/setCookie',(req ,res)=>{
  //   const query = req.query;
  //     var cert = fs.readFileSync("C:\\Users\\Nouman\\Desktop\\Basic Auth Flow\\ApiGateway\\keys\\public.pem");
  //     jwt.verify(query.id_token, cert, function(err, decoded) {
  //       if (err) {
  //         res.send(err);
  //       } else {
  //         console.log("valid"); 
  //         res.redirect(`http://localhost:7001/cookie?id_token=${query.id_token}&access_token=${query.access_token}&expiry=${query.expires_in}`);
  //       }
  //     });
  // })


  // gatewayExpressApp.get("/api/read",(req,res)=>{
  //   console.log(req.route.path);
  //   console.log("Read Hit.");
  //   const query = req.query;
  //     var cert = fs.readFileSync("C:\\Users\\Nouman\\Desktop\\Basic Auth Flow\\ApiGateway\\keys\\public.pem");
  //     jwt.verify(query.id_token, cert, function(err, decoded) {
  //       if (err) {
  //         res.send(err);
  //       } else {
  //         console.log("valid")      
  //         let access = decoded.roles;          
  //         console.log(decoded.sub)
  //         if(access.read==1){
  //           res.set({
  //             'user': decoded.sub
  //          });
  //           res.redirect(`http://localhost:7001${req.route.path}`);
  //         }
  //         else{
  //           res.status(401).send('User do not have access to read.');
  //         }}
  //     });
  // })

  // gatewayExpressApp.get("/api/write",(req,res)=>{
  //   console.log("Write Hit.");
  //   const query = req.query;
  //     var cert = fs.readFileSync("C:\\Users\\Nouman\\Desktop\\Basic Auth Flow\\ApiGateway\\keys\\public.pem");
  //     jwt.verify(query.id_token, cert, function(err, decoded) {
  //       if (err) {
  //         res.send(err);
  //       } else {
  //         console.log("valid");
  //         let access = decoded.roles;
  //         if(access.write==1){
  //           res.redirect(`http://localhost:7001${req.route.path}`);
  //         }
  //         else{
  //           res.status(401).send('User do not have access to write.');
  //         }}
  //     });
  // })

  gatewayExpressApp.get("/callback",(req,res)=>{    
    console.log("Valid Token.")       
    let token_id = req.query.id_token;        
    res.setHeader('content-type', 'application/json');    
    res.setHeader('Set-Cookie',`tokenId=${JSON.stringify(token_id)}`);
    res.send("Cookie Saved.")
  })
};
